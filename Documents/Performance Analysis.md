# Performance Analysis

This document was generated from the performance tests on [`d077560469`](https://github.com/numist/Diffing-Explorations/tree/d077560469ea124ee42caa9862669cbb780c8be2) (Thu May 21 19:47:39 2020 -0700)

```
        ┌───────────────────────────────────────────────────────────┐
        │                          Legend:                          │
        │                                                           │
        │ 'n=' -- size of the collections being diffed              │
        │'|Δ|' -- count of individual changes in the diffs          │
        │ '==' -- count of element equality evaluations             │
        │  '⌛︎' -- wall clock time (when both algorithms exceed 10ms)│
        └───────────────────────────────────────────────────────────┘
```

## Real world

### File diff (by line)

This test diffs SQLite's btree.c between versions [79ce96ab39](https://www.sqlite.org/src/info/79ce96ab39) and [f55ea8f456](https://www.sqlite.org/src/info/f55ea8f456). For reference, The algorithm used by `diff(1)` runs in about 20ms and produces 2259 edits, so in this case `club` is slightly more accurate only ~5x slower, despite the diffutils suite being written in illegibly-optimized C.

```
================================= club/myers =================================
n=(10518,9878):  |Δ|:2238/1832 (+22.2%)  ==:96364/1690406 (5.7%)  ⌛︎:0.10/0.35 (28.5%)
```

## Contrivations

### `"0"×1000 + "1"×1000` → `"1"×1000 + "0"×1000`

This is a worst-case test for any Myers-derived algorithm, producing a maximum number of edit paths despite a result that is 50% matches.

`club`'s work queue supports a capacity limit (currently tuned to 50) that linearizes performance against such worst-case workloads. This can be seen in the metrics as an order of magnitude improvement in both comparisons and runtime.

```
================================= club/myers =================================
n=(500,500):    |Δ|:500/500 (+0.0%)    ==:3124/63000 (5.0%)     ⌛︎:0.01/0.01 (50.7%)
n=(1000,1000):  |Δ|:1000/1000 (+0.0%)  ==:6251/251000 (2.5%)    ⌛︎:0.01/0.03 (29.0%)
n=(5000,5000):  |Δ|:5000/5000 (+0.0%)  ==:31251/6255000 (0.5%)  ⌛︎:0.04/0.64 (5.7%)
```

### `[…]` → `[]` and `[]` → `[…]`

These tests diff from an empty collection to one that contains `n` elements (and vice-versa), which is a very common workload for UI frameworks.

This workload turns Myers' greatest strength into a weakness: the triangular matrix it uses to track work is extended one level for every edit, causing the algorithm to iterate over invalid coordinates (like `(1,1)`). `club` restricts its work to the limits of `(0..<n, 0..<m)`, but since this case is so common there's also a short-circuit when one collection or the other is completely empty.

```
================================= pave/myers =================================
n=(10000,0):  |Δ|:10000/10000 (+0.0%)  ==:0/0 (nan%)  ⌛︎:0.03/0.83 (3.4%)
n=(0,10000):  |Δ|:10000/10000 (+0.0%)  ==:0/0 (nan%)  ⌛︎:0.03/1.10 (2.4%)
```

Of note: these measurements were taken *without* any improvements to `CollectionDifference.init()`, which is where this profile spent 85% of its time.

### `Array(0..<n)` -> `….reversed()`

This is the test that absolutely proves the value of consulting n-grams while diffing. Myers-based O(*n×d*) algorithms find their worst performance when *d*==*n*, but `club` is able to produce this diff in O(*n*) time.

```
================================= club/myers =================================
n=(500,500):    |Δ|:998/998 (+0.0%)    ==:5400/249501 (2.2%)     ⌛︎:0.00/0.02 (24.2%)
n=(1000,1000):  |Δ|:1998/1998 (+0.0%)  ==:9628/999001 (1.0%)     ⌛︎:0.01/0.05 (16.7%)
n=(5000,5000):  |Δ|:9998/9998 (+0.0%)  ==:62473/24995001 (0.2%)  ⌛︎:0.04/1.36 (3.1%)
```

### `(0..<n).map { UUID() }` → various

When inputs do not contain duplicated elements (as is common when diffing lists of identifiers), the `arrow` algorithm is selected, producing a very compact diff (*usually* a shortest edit script) in true linear time.

```
================================= arrow/myers =================================
n=(500,505):      |Δ|:123/123 (+0.0%)      ==:3981/8134 (48.9%)        ⌛︎:0.01/0.01 (79.2%)
n=(500,494):      |Δ|:230/230 (+0.0%)      ==:4335/27095 (16.0%)       ⌛︎:0.00/0.01 (67.6%)
n=(500,500):      |Δ|:338/338 (+0.0%)      ==:4727/57843 (8.2%)        ⌛︎:0.01/0.01 (72.4%)
n=(500,524):      |Δ|:394/394 (+0.0%)      ==:5329/78373 (6.8%)        ⌛︎:0.01/0.01 (54.9%)
n=(500,500):      |Δ|:466/466 (+0.0%)      ==:5591/109386 (5.1%)       ⌛︎:0.01/0.01 (57.0%)
n=(500,500):      |Δ|:930/924 (+0.6%)      ==:6615/225687 (2.9%)       ⌛︎:0.01/0.03 (44.9%)
n=(500,500):      |Δ|:998/998 (+0.0%)      ==:7003/249501 (2.8%)       ⌛︎:0.01/0.02 (31.0%)
n=(500,500):      |Δ|:1000/1000 (+0.0%)    ==:4262/250000 (1.7%)       ⌛︎:0.01/0.03 (22.6%)
n=(1000,1006):    |Δ|:254/254 (+0.0%)      ==:8264/33409 (24.7%)       ⌛︎:0.01/0.01 (146.9%)
n=(1000,1008):    |Δ|:466/466 (+0.0%)      ==:8910/109854 (8.1%)       ⌛︎:0.01/0.01 (79.5%)
n=(1000,993):     |Δ|:647/647 (+0.0%)      ==:9733/210721 (4.6%)       ⌛︎:0.01/0.02 (53.3%)
n=(1000,1007):    |Δ|:821/821 (+0.0%)      ==:9437/338546 (2.8%)       ⌛︎:0.02/0.03 (56.1%)
n=(1000,1047):    |Δ|:983/983 (+0.0%)      ==:10944/484532 (2.3%)      ⌛︎:0.02/0.04 (36.6%)
n=(1000,1000):    |Δ|:1894/1880 (+0.7%)    ==:13472/924590 (1.5%)      ⌛︎:0.02/0.09 (24.7%)
n=(1000,1000):    |Δ|:1998/1998 (+0.0%)    ==:13757/999001 (1.4%)      ⌛︎:0.01/0.08 (10.9%)
n=(1000,1000):    |Δ|:2000/2000 (+0.0%)    ==:10130/1000000 (1.0%)     ⌛︎:0.01/0.09 (10.9%)
n=(5000,4993):    |Δ|:1263/1263 (+0.0%)    ==:43319/803311 (5.4%)      ⌛︎:0.03/0.08 (41.0%)
n=(5000,4988):    |Δ|:2326/2326 (+0.0%)    ==:50304/2711560 (1.9%)     ⌛︎:0.04/0.19 (22.8%)
n=(5000,5019):    |Δ|:3329/3329 (+0.0%)    ==:54035/5548267 (1.0%)     ⌛︎:0.06/0.38 (16.0%)
n=(5000,5038):    |Δ|:4124/4124 (+0.0%)    ==:59306/8511424 (0.7%)     ⌛︎:0.06/0.54 (10.9%)
n=(5000,5067):    |Δ|:4867/4867 (+0.0%)    ==:63017/11842713 (0.5%)    ⌛︎:0.06/0.76 (8.4%)
n=(5000,5000):    |Δ|:9778/9728 (+0.5%)    ==:79180/24103052 (0.3%)    ⌛︎:0.07/1.86 (4.0%)
n=(5000,5000):    |Δ|:9998/9998 (+0.0%)    ==:57063/24995001 (0.2%)    ⌛︎:0.04/1.95 (2.2%)
n=(5000,5000):    |Δ|:10000/10000 (+0.0%)  ==:68270/25000000 (0.3%)    ⌛︎:0.04/2.16 (2.0%)
n=(10000,9944):   |Δ|:2504/2504 (+0.0%)    ==:85132/3146401 (2.7%)     ⌛︎:0.07/0.22 (32.7%)
n=(10000,9987):   |Δ|:4599/4599 (+0.0%)    ==:95564/10588202 (0.9%)    ⌛︎:0.08/0.70 (11.4%)
n=(10000,9998):   |Δ|:6624/6624 (+0.0%)    ==:112469/21952939 (0.5%)   ⌛︎:0.12/1.46 (8.2%)
n=(10000,9955):   |Δ|:8267/8267 (+0.0%)    ==:116978/34187110 (0.3%)   ⌛︎:0.12/2.22 (5.2%)
n=(10000,9749):   |Δ|:9679/9679 (+0.0%)    ==:121123/46830776 (0.3%)   ⌛︎:0.13/3.06 (4.3%)
n=(10000,10000):  |Δ|:19700/19624 (+0.4%)  ==:159239/97491621 (0.2%)   ⌛︎:0.15/7.59 (1.9%)
n=(10000,10000):  |Δ|:19998/19998 (+0.0%)  ==:116360/99990001 (0.1%)   ⌛︎:0.09/8.10 (1.1%)
n=(10000,10000):  |Δ|:20000/20000 (+0.0%)  ==:114692/100000000 (0.1%)  ⌛︎:0.08/8.75 (0.9%)
```

Of note: `arrow` is the algorithm that powers `-[NSOrderedSet differenceFromOrderedSet:]`, and [foreshadowed](https://twitter.com/numist/status/1153871655682207745) `club`.

## Randomly-generated

The following tests characterize `club`'s relative performance with randomly-generated inputs that vary in alphabet, size, and edit density.

### Binary

The Binary alphabet uses frequences of 50% `"0"` and 50% `"1"`.

These are the worst results of the test suite. Compared to Myers, `club` struggles to show performance improvements when statistically the string is half matches, while producing diffs with significantly more changes especially in shuffled tests.

The good news here is that the raw time numbers here are tiny, and `club`'s performance starts pulling ahead significantly as *n* grows beyond ~5000.

```
================================= club/myers =================================
n=(500,505):      |Δ|:383/97 (+294.8%)     ==:3800/10004 (38.0%)      ⌛︎:0.01/0.00 (177.6%)
n=(500,494):      |Δ|:364/144 (+152.8%)    ==:4524/19838 (22.8%)      ⌛︎:0.01/0.00 (192.3%)
n=(500,500):      |Δ|:266/156 (+70.5%)     ==:4622/22890 (20.2%)      ⌛︎:0.01/0.00 (135.6%)
n=(500,500):      |Δ|:440/182 (+141.8%)    ==:3395/30772 (11.0%)      ⌛︎:0.00/0.00 (123.3%)
n=(500,524):      |Δ|:418/182 (+129.7%)    ==:3160/30197 (10.5%)      ⌛︎:0.00/0.00 (110.2%)
n=(500,500):      |Δ|:324/192 (+68.8%)     ==:4434/33741 (13.1%)      ⌛︎:0.01/0.00 (185.3%)
n=(500,500):      |Δ|:408/194 (+110.3%)    ==:3108/33938 (9.2%)       ⌛︎:0.01/0.01 (171.5%)
n=(1000,1006):    |Δ|:794/200 (+297.0%)    ==:6255/39117 (16.0%)      ⌛︎:0.01/0.01 (139.8%)
n=(1000,1008):    |Δ|:808/286 (+182.5%)    ==:6770/79469 (8.5%)       ⌛︎:0.01/0.01 (104.0%)
n=(1000,993):     |Δ|:613/313 (+95.8%)     ==:10156/92122 (11.0%)     ⌛︎:0.01/0.01 (129.9%)
n=(1000,1007):    |Δ|:693/363 (+90.9%)     ==:9979/120602 (8.3%)      ⌛︎:0.01/0.01 (111.4%)
n=(1000,1047):    |Δ|:697/369 (+88.9%)     ==:10741/126655 (8.5%)     ⌛︎:0.01/0.02 (60.6%)
n=(1000,1000):    |Δ|:674/370 (+82.2%)     ==:11342/126181 (9.0%)     ⌛︎:0.02/0.01 (167.1%)
n=(1000,1000):    |Δ|:848/372 (+128.0%)    ==:7938/127804 (6.2%)      ⌛︎:0.02/0.02 (140.8%)
n=(5000,4993):    |Δ|:3561/947 (+276.0%)   ==:51189/864314 (5.9%)     ⌛︎:0.07/0.08 (85.9%)
n=(5000,4988):    |Δ|:4120/1454 (+183.4%)  ==:31508/2013004 (1.6%)    ⌛︎:0.05/0.14 (34.4%)
n=(5000,5019):    |Δ|:4093/1681 (+143.5%)  ==:38642/2616634 (1.5%)    ⌛︎:0.06/0.25 (23.5%)
n=(5000,5038):    |Δ|:4088/1768 (+131.2%)  ==:35985/2919278 (1.2%)    ⌛︎:0.06/0.22 (28.4%)
n=(5000,5067):    |Δ|:4259/1825 (+133.4%)  ==:38875/3094487 (1.3%)    ⌛︎:0.04/0.22 (20.6%)
n=(5000,5000):    |Δ|:3380/1830 (+84.7%)   ==:54867/3081904 (1.8%)    ⌛︎:0.07/0.22 (29.9%)
n=(5000,5000):    |Δ|:4188/1910 (+119.3%)  ==:37764/3242925 (1.2%)    ⌛︎:0.05/0.24 (18.7%)
n=(10000,9944):   |Δ|:8214/1954 (+320.4%)  ==:62939/3629676 (1.7%)    ⌛︎:0.09/0.27 (34.2%)
n=(10000,9987):   |Δ|:8331/2859 (+191.4%)  ==:63291/7593173 (0.8%)    ⌛︎:0.12/0.67 (18.0%)
n=(10000,9998):   |Δ|:8234/3344 (+146.2%)  ==:68195/10311856 (0.7%)   ⌛︎:0.13/0.86 (15.2%)
n=(10000,9955):   |Δ|:8223/3543 (+132.1%)  ==:79142/11540845 (0.7%)   ⌛︎:0.10/0.92 (11.1%)
n=(10000,9749):   |Δ|:6583/3625 (+81.6%)   ==:90185/12007302 (0.8%)   ⌛︎:0.17/1.03 (16.0%)
n=(10000,10000):  |Δ|:8462/3814 (+121.9%)  ==:68374/12903037 (0.5%)   ⌛︎:0.09/0.94 (9.6%)
n=(10000,10000):  |Δ|:6942/3828 (+81.3%)   ==:100561/12934884 (0.8%)  ⌛︎:0.15/0.90 (16.4%)
```

### Genes

The Genes alphabet uses frequences of 25% `"A"`, 25% `"C"`, 25% `"G"`, and 25% `"T"`.

Very similar to the Binary tests, but with `club` showing more of an advantage as n-gram testing becomes more useful given the larger alphabet. Diff size is still significantly regressed for shuffled tests collections due to tiny alphabet.

```
================================= club/myers =================================
n=(500,505):      |Δ|:203/119 (+70.6%)      ==:4638/10072 (46.0%)      ⌛︎:0.01/0.01 (104.4%)
n=(500,494):      |Δ|:312/196 (+59.2%)      ==:6027/25898 (23.3%)      ⌛︎:0.01/0.00 (175.2%)
n=(1000,1006):    |Δ|:1106/238 (+364.7%)    ==:8742/39111 (22.4%)      ⌛︎:0.01/0.01 (221.8%)
n=(500,500):      |Δ|:446/272 (+64.0%)      ==:7416/49210 (15.1%)      ⌛︎:0.01/0.01 (111.5%)
n=(500,524):      |Δ|:466/286 (+62.9%)      ==:7539/54183 (13.9%)      ⌛︎:0.01/0.01 (123.9%)
n=(500,500):      |Δ|:458/300 (+52.7%)      ==:8122/59176 (13.7%)      ⌛︎:0.01/0.01 (169.0%)
n=(500,500):      |Δ|:472/352 (+34.1%)      ==:5657/69647 (8.1%)       ⌛︎:0.01/0.01 (104.7%)
n=(500,500):      |Δ|:408/358 (+14.0%)      ==:7006/70816 (9.9%)       ⌛︎:0.01/0.01 (82.7%)
n=(1000,1008):    |Δ|:948/392 (+141.8%)     ==:10495/101713 (10.3%)    ⌛︎:0.02/0.01 (147.0%)
n=(1000,993):     |Δ|:783/501 (+56.3%)      ==:11987/165852 (7.2%)     ⌛︎:0.02/0.02 (93.9%)
n=(1000,1007):    |Δ|:739/585 (+26.3%)      ==:13633/225508 (6.0%)     ⌛︎:0.02/0.02 (79.2%)
n=(1000,1047):    |Δ|:863/633 (+36.3%)      ==:13744/262514 (5.2%)     ⌛︎:0.02/0.02 (99.8%)
n=(1000,1000):    |Δ|:822/686 (+19.8%)      ==:18263/270932 (6.7%)     ⌛︎:0.02/0.04 (63.2%)
n=(1000,1000):    |Δ|:910/692 (+31.5%)      ==:13063/277531 (4.7%)     ⌛︎:0.02/0.03 (67.8%)
n=(5000,4993):    |Δ|:2165/1139 (+90.1%)    ==:55104/858535 (6.4%)     ⌛︎:0.07/0.09 (75.7%)
n=(5000,4988):    |Δ|:4972/1992 (+149.6%)   ==:54249/2614321 (2.1%)    ⌛︎:0.08/0.21 (41.4%)
n=(10000,9944):   |Δ|:11350/2292 (+395.2%)  ==:82166/3477255 (2.4%)    ⌛︎:0.17/0.27 (63.0%)
n=(5000,5019):    |Δ|:4507/2541 (+77.4%)    ==:131763/4225680 (3.1%)   ⌛︎:0.12/0.31 (37.8%)
n=(5000,5038):    |Δ|:3970/2906 (+36.6%)    ==:98116/5550263 (1.8%)    ⌛︎:0.12/0.40 (29.7%)
n=(5000,5067):    |Δ|:4433/3097 (+43.1%)    ==:127573/6269808 (2.0%)   ⌛︎:0.12/0.44 (26.6%)
n=(5000,5000):    |Δ|:4214/3490 (+20.7%)    ==:96696/6809619 (1.4%)    ⌛︎:0.12/0.53 (22.1%)
n=(5000,5000):    |Δ|:4190/3504 (+19.6%)    ==:111445/6850417 (1.6%)   ⌛︎:0.10/0.51 (20.1%)
n=(10000,9987):   |Δ|:8105/3915 (+107.0%)   ==:168395/10076419 (1.7%)  ⌛︎:0.22/0.74 (30.1%)
n=(10000,9998):   |Δ|:8966/5084 (+76.4%)    ==:168188/16882329 (1.0%)  ⌛︎:0.22/1.15 (18.7%)
n=(10000,9955):   |Δ|:8175/5779 (+41.5%)    ==:182600/21812769 (0.8%)  ⌛︎:0.25/1.51 (16.7%)
n=(10000,9749):   |Δ|:8941/6193 (+44.4%)    ==:172104/24600104 (0.7%)  ⌛︎:0.19/1.67 (11.3%)
n=(10000,10000):  |Δ|:8444/6958 (+21.4%)    ==:302503/27019541 (1.1%)  ⌛︎:0.25/1.95 (12.6%)
n=(10000,10000):  |Δ|:8602/6962 (+23.6%)    ==:194033/26992686 (0.7%)  ⌛︎:0.21/1.93 (10.7%)
```

### Letters

The Letters alphabet uses characters in the set `[a-z ]` with frequences derived from the English language.

With this size alphabet (or larger), `club` is basically always a net win in wall clock time, with reasonable diff quality.

```
================================= club/myers =================================
n=(500,505):      |Δ|:149/123 (+21.1%)      ==:5690/8516 (66.8%)       ⌛︎:0.01/0.01 (83.8%)
n=(500,494):      |Δ|:268/228 (+17.5%)      ==:5970/28019 (21.3%)      ⌛︎:0.01/0.01 (96.2%)
n=(500,500):      |Δ|:396/324 (+22.2%)      ==:5995/56297 (10.6%)      ⌛︎:0.01/0.01 (90.4%)
n=(500,524):      |Δ|:454/366 (+24.0%)      ==:8703/71312 (12.2%)      ⌛︎:0.01/0.01 (125.1%)
n=(500,500):      |Δ|:522/406 (+28.6%)      ==:6046/88186 (6.9%)       ⌛︎:0.01/0.01 (84.0%)
n=(500,500):      |Δ|:670/600 (+11.7%)      ==:12747/134398 (9.5%)     ⌛︎:0.04/0.02 (182.8%)
n=(500,500):      |Δ|:684/608 (+12.5%)      ==:11326/132924 (8.5%)     ⌛︎:0.02/0.02 (96.5%)
n=(1000,1006):    |Δ|:302/250 (+20.8%)      ==:8854/34211 (25.9%)      ⌛︎:0.02/0.01 (134.7%)
n=(1000,1008):    |Δ|:496/446 (+11.2%)      ==:9444/105905 (8.9%)      ⌛︎:0.02/0.01 (112.0%)
n=(1000,993):     |Δ|:673/607 (+10.9%)      ==:11607/195833 (5.9%)     ⌛︎:0.02/0.02 (100.3%)
n=(1000,1007):    |Δ|:893/761 (+17.3%)      ==:13859/307629 (4.5%)     ⌛︎:0.02/0.03 (66.6%)
n=(1000,1047):    |Δ|:1081/883 (+22.4%)     ==:16874/414489 (4.1%)     ⌛︎:0.02/0.04 (53.0%)
n=(1000,1000):    |Δ|:1326/1202 (+10.3%)    ==:29705/532747 (5.6%)     ⌛︎:0.03/0.07 (49.1%)
n=(1000,1000):    |Δ|:1348/1204 (+12.0%)    ==:28416/530719 (5.4%)     ⌛︎:0.04/0.10 (39.9%)
n=(5000,4993):    |Δ|:1439/1239 (+16.1%)    ==:46396/811087 (5.7%)     ⌛︎:0.06/0.12 (48.0%)
n=(5000,4988):    |Δ|:2568/2252 (+14.0%)    ==:53618/2677811 (2.0%)    ⌛︎:0.09/0.22 (38.5%)
n=(5000,5019):    |Δ|:5393/3101 (+73.9%)    ==:125685/5086731 (2.5%)   ⌛︎:0.16/0.45 (35.0%)
n=(5000,5038):    |Δ|:4362/3738 (+16.7%)    ==:62987/7403496 (0.9%)    ⌛︎:0.09/0.54 (16.3%)
n=(5000,5067):    |Δ|:6121/4303 (+42.2%)    ==:198195/9831890 (2.0%)   ⌛︎:0.27/0.76 (36.2%)
n=(5000,5000):    |Δ|:6646/5956 (+11.6%)    ==:184738/13058529 (1.4%)  ⌛︎:0.23/1.15 (20.4%)
n=(5000,5000):    |Δ|:6572/6014 (+9.3%)     ==:228105/13055072 (1.7%)  ⌛︎:0.24/1.15 (20.9%)
n=(10000,9944):   |Δ|:2912/2468 (+18.0%)    ==:86399/3210493 (2.7%)    ⌛︎:0.12/0.34 (34.4%)
n=(10000,9987):   |Δ|:5053/4405 (+14.7%)    ==:106869/10232255 (1.0%)  ⌛︎:0.13/1.40 (9.2%)
n=(10000,9998):   |Δ|:7136/6160 (+15.8%)    ==:124819/20052894 (0.6%)  ⌛︎:0.19/1.51 (12.4%)
n=(10000,9955):   |Δ|:8935/7507 (+19.0%)    ==:137793/29858176 (0.5%)  ⌛︎:0.20/2.35 (8.5%)
n=(10000,9749):   |Δ|:12109/8575 (+41.2%)   ==:344149/38990276 (0.9%)  ⌛︎:0.46/3.02 (15.3%)
n=(10000,10000):  |Δ|:13238/11858 (+11.6%)  ==:659390/51786545 (1.3%)  ⌛︎:0.61/4.38 (13.9%)
n=(10000,10000):  |Δ|:13252/11878 (+11.6%)  ==:579536/51842309 (1.1%)  ⌛︎:0.62/4.12 (15.1%)
```

